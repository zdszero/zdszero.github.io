<!doctype html>
<html >

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />

  <link rel="stylesheet" type="text/css" href="../../WikiTheme/template.css" />

  <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
  <script type='text/javascript' src="../../WikiTheme/menu/js/jquery.cookie.js"></script>
  <script type='text/javascript' src="../../WikiTheme/menu/js/jquery.hoverIntent.minified.js"></script>
  <script type='text/javascript' src="../../WikiTheme/menu/js/jquery.dcjqaccordion.2.7.min.js"></script>
  <script type="text/javascript" src="../../WikiTheme/menu/js/jquery.sticky-kit.js "></script>
  <script type="text/javascript" src="../../WikiTheme/menu/js/sticky_menu.js"></script>

  <link rel="stylesheet" type="text/css" href="../../WikiTheme/menu/css/skins/blue.css"/>
  <link rel="stylesheet" type="text/css" href="../../WikiTheme/menu/css/skins/graphite.css"/>
  <link rel="stylesheet" type="text/css" href="../../WikiTheme/menu/css/skins/grey.css"/>

  <meta name="generator" content="pandoc" />
      <title>
    MHA
  </title>
    <link rel="stylesheet" href="../../WikiTheme/theme/bootstrap.css"  />
        <script
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
        type="text/javascript"></script>
      </head>

<body>
    <div class="navbar navbar-static-top">
    <div class="navbar-inner">
      <div class="container">
        <span class="doc-title">MHA</span>
        <ul class="nav pull-right doc-info">
          <p class="navbar-text">
                                                      </p>
                  </ul>
      </div>
    </div>
  </div>
    <div class="container">
    <div class="row">
            <div class="span12">
                <ul>
                <li><span class="math inline">\([\mathbf{q}_{t,1};
                \mathbf{q}_{t,2}; ...; \mathbf{q}_{t,n_h}] =
                \mathbf{q}_t = W^{Q} \mathbf{h}_{t}\)</span></li>
                <li><span class="math inline">\([\mathbf{k}_{t,1};
                \mathbf{k}_{t,2}; ...; \mathbf{k}_{t,n_h}] =
                \mathbf{k}_t = W^{K} \mathbf{h}_{t}\)</span></li>
                <li><span class="math inline">\([\mathbf{v}_{t,1};
                \mathbf{v}_{t,2}; ...; \mathbf{v}_{t,n_h}] =
                \mathbf{v}_t = W^{V} \mathbf{h}_{t}\)</span></li>
                <li><span class="math inline">\(\mathbf{o}_{t,i} =
                \sum_{j=1}^{t}
                \text{Softmax}_j\left(\frac{\mathbf{q}_{t,i}
                \mathbf{k}_{j,i}^\top}{\sqrt{d_h}}\right)
                \mathbf{v}_{j,i}\)</span>
                <ul>
                <li><span class="math inline">\(i\)</span> 表示第 <span
                class="math inline">\(i\)</span> 个 head</li>
                <li><span class="math inline">\(t\)</span> 当时计算第
                <span class="math inline">\(t\)</span> 个 token 的
                attention</li>
                </ul></li>
                <li><span class="math inline">\(\mathbf{u}_t =
                W^O[\mathbf{o}_{t,1}; \mathbf{o}_{t,2}; ...;
                \mathbf{o}_{t,n_h}]\)</span></li>
                </ul>
                <p>上述公式是 q_len = 1 的场景，并且考察了多头，head
                的下标用变量 <span class="math inline">\(i\)</span>
                表示。</p>
                <p>更简单的方式是去除多头的符号，因为 head，q_len
                是可以并行的扩展。</p>
                <ul>
                <li><span class="math inline">\(\mathbf{o}_{t} =
                \sum_{j=1}^{t}
                \text{Softmax}_j\left(\frac{\mathbf{q}_{t}
                \mathbf{k}_{j}^\top}{\sqrt{d_h}}\right)
                \mathbf{v}_{j}\)</span></li>
                </ul>
                <figure>
                <img
                src="../.././WikiImage/mha_computation.drawio.svg"
                alt="mha process" />
                <figcaption aria-hidden="true">mha process</figcaption>
                </figure>
                <p>可以通过上述图示理解 MHA 的过程，Q 由 q_len 个 q
                向量组成（在 torch 中一般表示为行向量），K 和 V 由
                kv_len 个列向量组成</p>
              </div>
    </div>
  </div>
</body>

</html>
